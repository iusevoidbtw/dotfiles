#!/bin/sh

backupname="backup"
servicedir="/var/service"

if [ -e "$backupname" ]; then
	echo "$backupname already exists." >&2
	exit 1
fi
if [ -e "$backupname.tar.xz" ]; then
	echo "$backupname.tar.xz already exists." >&2
	exit 1
fi

mkdir -v "$backupname"
cd "$backupname"

rootdir="$(pwd)"
homedir="$rootdir/home"
etcdir="$rootdir/etc"

# --------------------------------------
# DOTFILES

mkdir -v "$homedir"
for f in `cd $HOME && git --git-dir=$HOME/.dot/ --work-tree=$HOME ls-files && cd $homedir`; do
	newdir="$(dirname $f)"
	if [ "$newdir" = "." ]; then
		cp -v "$HOME/$f" ./
	else
		mkdir -vp "./$newdir"
		cp -v "$HOME/$f" "./$f"
	fi
done

# END OF DOTFILES
# --------------------------------------


# --------------------------------------
# ETC DIR

mkdir -v "$etcdir"
cd "$etcdir"

# --- XBPS ---
echo "copying xbps config"
cp -vr "/etc/xbps.d" ./

# --- GRUB ---
echo "copying grub config"
mkdir -v "default"
cp -v "/etc/default/grub" "default/"

# --- RC.LOCAL ---
echo "copying rc.local"
cp -v "/etc/rc.local" ./

# --- MODPROBE ---
echo "copying modprobe config"
cp -vr "/etc/modprobe.d" ./

# --- SYSCTL ---
echo "copying sysctl config"
cp -vr "/etc/sysctl.d" ./

# --- IWD ---
echo "copying iwd config"
cp -vr "/etc/iwd" ./

# --- UDEV RULES ---
echo "copying udev rules"
mkdir -v "udev"
cp -vr "/etc/udev/rules.d" ./udev/

# END OF ETC DIR
# --------------------------------------


# --------------------------------------
# MISC

cd "$rootdir"

echo "creating list of packages (xbps-query -l | awk '{ print \$2 }' | xargs -n1 xbps-uhelper getpkgname) > packages"
xbps-query -l | awk '{ print $2 }' | xargs -n1 xbps-uhelper getpkgname > packages

echo "creating list of daemons (ls -lLA \"$servicedir\" > daemons)"
ls -lLA "$servicedir" > daemons

# END OF MISC
# --------------------------------------

echo "creating $backupname.tar.xz"

cd ..
tar cJf "$backupname.tar.xz" "$backupname" > /dev/null
rm -rf "$backupname"
echo "done"
